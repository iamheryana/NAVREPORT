/****************************************Name sprocs	: P_AngsPiutCreate by	: SuheDate		: 10-11-2003Description	: Proses Create rencana Angsuran PiutangCall From	: F/ESub sprocs	: -*****************************************/CREATE OR REPLACE FUNCTION  P_AngsPiut (l_Sistem	VARCHAR(1),						l_NIP			VARCHAR(10),						l_SisPokok		DECIMAL(15,2),						l_SisBunga		DECIMAL(15,2),						l_JnsPiutang	VARCHAR(4),						l_TglPiut		DATE,						l_AngsPokok		DECIMAL(15,2),						l_AngsBunga		DECIMAL(15,2),						l_JmlBulan		INT,						l_TglAwProrata	DATE,						l_TglAwPokok	DATE, 						l_TglAwBunga	DATE)RETURNS void AS $$  --DECLARE		l_BayPokok	DECIMAL(15,2);			l_BayBunga	DECIMAL(15,2);			l_Loop		INT;			l_TglDocu	DATE;			l_NIP		VARCHAR(10);--BEGIN	IF l_SisPokok > 0 THEN		IF l_SisTem='P' THEN			l_BayPokok:=FLOOR(l_SisPokok/l_JmlBulan);			l_TglDocu :=l_TglAwProrata;			l_Loop	  :=1;						WHILE l_Loop<= l_JmlBulan LOOP				IF l_Loop=l_JmlBulan THEN					l_BayPokok:=l_SisPokok;				END IF;				SELECT NIP INTO l_NIP FROM T06DPIU WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;				IF l_NIP IS NOT NULL THEN					UPDATE T06DPIU SET JmlAngs=COALESCE(JmlAngs,0)+l_BayPokok WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;				ELSE 					INSERT INTO T06DPIU(NIP ,KdJnsP,TgDoku  ,PrdAngs ,JmlAngs  ,JmlBunga) VALUES(l_NIP,l_JnsPiutang,l_TglPiut,l_TglDocu,l_BayPokok,0);				END IF;				l_TglDocu:=l_TglDocu+INTERVAL '1 MONTH';				l_SisPokok:=l_SisPokok - l_BayPokok;				l_Loop:= l_Loop +1;			END LOOP;		ELSIF l_SisTem='N' AND l_AngsPokok>0 THEN			l_BayPokok:=l_AngsPokok;			l_TglDocu :=l_TglAwPokok;			WHILE l_SisPokok>0 LOOP				IF l_SisPokok<l_BayPokok THEN					l_BayPokok:=l_SisPokok;                END IF; 				SELECT NIP INTO l_NIP FROM T06DPIU WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;				IF l_NIP is NOT NULL THEN					UPDATE T06DPIU SET JmlAngs=ISNULL(JmlAngs,0)+l_BayPokok WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;				ELSE					 INSERT INTO T06DPIU(NIP ,KdJnsP ,TgDoku  ,PrdAngs ,JmlAngs  ,JmlBunga) VALUES(l_NIP,l_JnsPiutang,l_TglPiut,l_TglDocu,l_BayPokok,0);				END IF;				l_Loop := l_Loop +1;				l_TglDocu:=l_TglDocu+INTERVAL '1 MONTH';				l_SisPokok :=l_SisPokok - l_BayPokok;			END LOOP;		END IF;		END IF;	IF l_SisBunga>0 THEN 		IF l_SisTem='P' THEN			l_BayPokok:=FLOOR(l_SisPokok/l_JmlBulan);			l_TglDocu :=l_TglAwProrata;			l_Loop	  :=1;			WHILE l_Loop<= l_JmlBulan  LOOP				IF l_Loop=l_JmlBulan THEN					l_BayBunga:=l_SisBunga;				END IF;				SELECT NIP INTO l_NIP FROM T06DPIU WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;				IF l_NIP IS NOT NULL THEN					UPDATE T06DPIU SET JmlBunga=COALESCE(JmlBunga,0)+l_BayBunga WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;				ELSE					 INSERT INTO T06DPIU(NIP ,KdJnsP ,TgDoku  ,PrdAngs ,JmlAngs  ,JmlBunga) VALUES(l_NIP,l_JnsPiutang,l_TglPiut,l_TglDocu,l_BayPokok,0);				END IF;				l_Loop := l_Loop +1;				l_TglDocu:=l_TglDocu+INTERVAL '1 MONTH';				l_SisBunga :=l_SisBunga - l_BayBunga;			END LOOP;		END IF;		ELSIF l_SisTem='N' AND l_AngsBunga>0	THEN			l_BayBunga:=l_AngsBunga;		l_TglDocu :=l_TglAwBunga;				IF l_SisBunga>0 THEN			IF l_SisBunga<l_BayBunga THEN				l_BayBunga:=l_SisBunga;			END IF;			SELECT NIP INTO l_NIP FROM T06DPIU WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;			IF l_NIP IS NOT NULL THEN 				UPDATE T06DPIU SET JmlBunga=COALESCE(JmlBunga,0)+l_BayBunga WHERE NIP=l_NIP AND KdJnsP=l_JnsPiutang AND TgDoku=l_TglPiut AND PrdAngs=l_TglDocu;			ELSE				INSERT INTO T06DPIU(NIP ,KdJnsP     ,TgDoku  ,PrdAngs ,JmlAngs,JmlBunga) VALUES(l_NIP,l_JnsPiutang,l_TglPiut,l_TglDocu,0      ,l_BayBunga);			END IF;			l_TglDocu:=l_TglDocu+INTERVAL '1 MONTH';			l_SisBunga :=l_SisBunga - l_BayBunga ;		END IF;	END IF;END ;$$LANGUAGE 'plpgsql'; /*EXEC        P_AngsPiut  l_Sistem			='N',						l_NIP			='SUHE',						l_SisPokok		=100000,						l_SisBunga		=10000,						l_JnsPiutang		='TEST',						l_TglPiut		='2003-01-01',						l_AngsPokok		=30000,						l_AngsBunga		=3000,						l_JmlBulan		=3,						l_TglAwProrata	='2003-03-20',						l_TglAwPokok		='2003-03-20',						l_TglAwBunga		='2003-03-20'select * from  P_AngsPiut ('N','XXX',100000,10000,'MEDA','2013-11-19',30000,3000,3,'2013-11-20','2013-11-20','2001-11-20');SELECT * FROM T06DPIU*/