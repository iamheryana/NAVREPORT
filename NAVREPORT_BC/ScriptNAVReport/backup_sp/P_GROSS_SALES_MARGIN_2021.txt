USE [NavBI]
GO
/****** Object:  StoredProcedure [dbo].[P_GROSS_SALES_MARGIN_2021]    Script Date: 07-02-2023 4:39:15 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[P_GROSS_SALES_MARGIN_2021] 
	@ProsesId  nvarchar(100) ,   
	@TglAwalTahun  nvarchar(15) , 
	@TglFrom  nvarchar(15) , 
	@TglUpto  nvarchar(15) , 
	@Action  nvarchar(15)
AS   
BEGIN
	DECLARE @PeriodAwalTahun DATETIME = CAST(@TglAwalTahun AS DATETIME);
	DECLARE @PeriodFrom DATETIME = CAST(@TglFrom AS DATETIME);
	DECLARE @PeriodUpto DATETIME = CAST(@TglUpto AS DATETIME);
	--
	IF @Action = 'CETAK'
	BEGIN
		INSERT INTO [dbo].[TEMP11_GROSS_SALES_MARGIN]
				   ([TEMP11_ID]
				   ,[PROSES_ID]
				   ,[MAIN_GRP]
				   ,[GROUP_NO]
				   ,[GROUP_DESC]
				   ,[CUST_NO]
				   ,[UPTO_PREV_MONTH]
				   ,[CURR_MONTH])
		SELECT	ROW_NUMBER() OVER (PARTITION BY 1 ORDER BY XX.MAIN_GRP, XX.GROUP_NO) AS TEMP_ID
				, @ProsesId AS PROSES_ID
				, XX.MAIN_GRP
				, XX.GROUP_NO
				, XX.GROUP_DESC
				, XX.CUST_NO
				, XX.UPTO_PREV_MONTH 
				, XX.CURR_MONTH
		FROM	(
		SELECT	'A' AS MAIN_GRP
				, X.GROUP_NO
				, X.GROUP_DESC
				, X.CUST_NO
				, SUM(X.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH 
				, SUM(X.CURR_MONTH) AS CURR_MONTH
		FROM	(
					SELECT	 1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, GLE.[Source No_] AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
									FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	(GLE.[G_L Account No_] BETWEEN '400.110.00'  AND '420.110.01') AND
							GLE.[G_L Account No_] <> '400.110.04' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
					GROUP BY GLE.[Source No_]
					UNION ALL
					SELECT	 1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, 'SPONSORSHIP' AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
					WHERE	GLE.[G_L Account No_] = '400.110.04' AND
							(('ALL') = '10' OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
					GROUP BY GLE.[Source No_]
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASCY.CUST_NO
							, SUM(ASCY.AMOUNT) * -1 AS UPTO_PREV_MONTH
							, 0 AS CURR_MONTH
					FROM (
							SELECT	OUM.ITEM_CAT
									,OUM.CUST_NO
									,OUM.AMOUNT
							FROM	(
										SELECT	UM.ITEM_CAT
												,UM.CUST_NO
												,CASE WHEN ISNULL(INV.AMOUNT,0) = 0 THEN UM.AMOUNT ELSE
													CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN 0 ELSE
													SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
												END
												END	 AS AMOUNT
										FROM	(
													SELECT	DIMS.ITEM_CAT
															,DIMS.BRANCHES
															,SIH.[Posting Date] AS TGL_UM
															,SIH.[No_] AS NO_UM
															,SIH.[External Document No_] AS NO_PO_CUST
															,SIH.[Bill-to Customer No_] AS CUST_NO
															,SIH.[Bill-to Name] AS CUST_NAME
															,SIH.[Prepayment Order No_] AS NO_SO
															, (SUM(GLE.[Amount]) * -1) AS AMOUNT
													FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
													LEFT JOIN	(
																	SELECT [Dimension Set ID] AS DIM_ID
																			,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																			,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																			,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																	FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																	GROUP BY [Dimension Set ID]
																) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
													LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
													LEFT JOIN	(
																	SELECT CLE.[Entry No_]
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																	FROM [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE
																	LEFT JOIN [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																	WHERE CLE.[Document Type] IN (2,3)
																	AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																		(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																) CM ON CM.NO_UM = GLE.[Document No_]
													LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
													WHERE GLE.[G_L Account No_] = '400.110.03'
														  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
														  AND GLE.[Document No_] LIKE 'UM%'
														  AND (CM.NO_CM IS NULL OR (CM.NO_CM IS NOT NULL AND CMH.[Posting Date] > DATEADD(DAY,-1,@TglFrom) ))
														  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
														  AND (SIH.[Posting Date] >= @TglAwalTahun  AND SIH.[Posting Date]<= DATEADD(DAY,-1,@TglFrom))
													GROUP BY DIMS.ITEM_CAT,
															 DIMS.BRANCHES,
															 SIH.[Posting Date]
															,SIH.[No_]
															,SIH.[External Document No_]
															,SIH.[Bill-to Customer No_]
															,SIH.[Bill-to Name]
															,SIH.[Prepayment Order No_]
												) UM
										LEFT JOIN	(
														SELECT	DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_] AS NO_SO
																,MAX(SIH.[Posting Date]) AS TGL_INV
																,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT LIKE 'UM%'
															  AND GLE.[Posting Date] <=  DATEADD(DAY,-1,@TglFrom)
														GROUP BY DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_]
													) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
									) OUM
							WHERE OUM.AMOUNT > 0
						 ) ASCY
					GROUP BY ASCY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASCY.CUST_NO
							, 0 AS UPTO_PREV_MONTH
							, SUM(ASCY.AMOUNT) * -1 AS CURR_MONTH
					FROM (
							SELECT	OUM.ITEM_CAT
									,OUM.CUST_NO
									,OUM.AMOUNT
							FROM	(
										SELECT	UM.ITEM_CAT
												,UM.CUST_NO
												,CASE WHEN ISNULL(INV.AMOUNT,0) = 0 THEN UM.AMOUNT ELSE
													CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN 0 ELSE
													SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
												END
												END	 AS AMOUNT
										FROM	(
													SELECT	DIMS.ITEM_CAT
															,DIMS.BRANCHES
															,SIH.[Posting Date] AS TGL_UM
															,SIH.[No_] AS NO_UM
															,SIH.[External Document No_] AS NO_PO_CUST
															,SIH.[Bill-to Customer No_] AS CUST_NO
															,SIH.[Bill-to Name] AS CUST_NAME
															,SIH.[Prepayment Order No_] AS NO_SO
															, (SUM(GLE.[Amount]) * -1) AS AMOUNT
													FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
													LEFT JOIN	(
																	SELECT [Dimension Set ID] AS DIM_ID
																			,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																			,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																			,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																	FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																	GROUP BY [Dimension Set ID]
																) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
													LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
													LEFT JOIN	(
																	SELECT CLE.[Entry No_]
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																	FROM [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE
																	LEFT JOIN [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																	WHERE CLE.[Document Type] IN (2,3)
																	AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																		(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																) CM ON CM.NO_UM = GLE.[Document No_]
													LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
													WHERE GLE.[G_L Account No_] = '400.110.03'
														  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
														  AND GLE.[Document No_] LIKE 'UM%'
														  AND (CM.NO_CM IS NULL OR (CM.NO_CM IS NOT NULL AND CMH.[Posting Date] > @TglUpto ))
														  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
														  AND (SIH.[Posting Date] >= @TglFrom AND SIH.[Posting Date]<= @TglUpto)
													GROUP BY DIMS.ITEM_CAT,
															 DIMS.BRANCHES,
															 SIH.[Posting Date]
															,SIH.[No_]
															,SIH.[External Document No_]
															,SIH.[Bill-to Customer No_]
															,SIH.[Bill-to Name]
															,SIH.[Prepayment Order No_]
												) UM
										LEFT JOIN	(
														SELECT	DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_] AS NO_SO
																,MAX(SIH.[Posting Date]) AS TGL_INV
																,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT LIKE 'UM%'
															  AND GLE.[Posting Date] <=  @TglUpto
														GROUP BY DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_]
													) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
									) OUM
							WHERE OUM.AMOUNT > 0
						 ) ASCY
					GROUP BY ASCY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, CMLM.CUST_NO
							, 0 AS UPTO_PREV_MONTH
							, ISNULL(SUM(CMLM.AMOUNT),0) * -1 AS CURR_MONTH
					FROM	(
								SELECT	DIMS.ITEM_CAT
										,DIMS.BRANCHES
										,CMH.[Posting Date] AS TGL_CM
										,CMH.[No_] AS NO_CM
										,CMH.[External Document No_] AS NO_PO_CUST
										,CMH.[Bill-to Customer No_] AS CUST_NO
										,CMH.[Bill-to Name] AS CUST_NAME
										,CMH.[Prepayment Order No_] AS NO_SO
										, (SUM(GLE.[Amount]) * -1) AS AMOUNT
								FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
														,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
														,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
												FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CMH ON CMH.[No_] = GLE.[Document No_]
								LEFT JOIN	(
												SELECT CLE.[Entry No_]
														, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
														, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
												FROM [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE
												LEFT JOIN [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
												WHERE CLE.[Document Type] IN (2,3)
												AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
													(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
											) UM ON UM.NO_CM = GLE.[Document No_]
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = UM.NO_UM
								WHERE GLE.[G_L Account No_] = '400.110.03'
										AND GLE.[Document No_] NOT LIKE 'UM%'
										AND (CMH.[Posting Date] >= @TglFrom AND CMH.[Posting Date]<= @TglUpto)
										AND (SIH.[Posting Date] < @TglFrom)
								GROUP BY	DIMS.ITEM_CAT
											,DIMS.BRANCHES
											,CMH.[Posting Date]
											,CMH.[No_]
											,CMH.[External Document No_]
											,CMH.[Bill-to Customer No_]
											,CMH.[Bill-to Name]
											,CMH.[Prepayment Order No_]
							) CMLM
					GROUP BY CMLM.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASPY.CUST_NO
							, SUM(ASPY.AMOUNT) AS UPTO_PREV_MONTH
							, 0 AS CURR_MONTH
					FROM	(
								SELECT	OUM.ITEM_CAT
										,OUM.CUST_NO
										,OUM.AMOUNT
								FROM	(
											SELECT	UM.ITEM_CAT
													, UM.CUST_NO
													, CASE WHEN ISNULL(INV.AMOUNT,0) =  0 THEN 0 ELSE
														CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN
															UM.AMOUNT 
														ELSE
															--CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0) < ISNULL(INV.AMOUNT,0) THEN
															--	SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
															--ELSE
																ISNULL(INV.AMOUNT,0)
															--END
														END
													  END AS AMOUNT
											FROM	(
														SELECT	DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Posting Date] AS TGL_UM
																,SIH.[No_] AS NO_UM
																,SIH.[External Document No_] AS NO_PO_CUST
																,SIH.[Bill-to Customer No_] AS CUST_NO
																,SIH.[Bill-to Name] AS CUST_NAME
																,SIH.[Prepayment Order No_] AS NO_SO
																, (SUM(GLE.[Amount]) * -1) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														LEFT JOIN	(
																		SELECT CLE.[Entry No_]
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																		FROM [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE
																		LEFT JOIN [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																		WHERE CLE.[Document Type] IN (2,3)
																		AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																			(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																	) CM ON CM.NO_UM = GLE.[Document No_]
														LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
															  AND GLE.[Document No_] LIKE 'UM%'
															  AND CM.NO_CM IS NULL
															  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
															  AND (SIH.[Posting Date] < @TglAwalTahun )
														GROUP BY DIMS.ITEM_CAT,
																 DIMS.BRANCHES,
																 SIH.[Posting Date]
																,SIH.[No_]
																,SIH.[External Document No_]
																,SIH.[Bill-to Customer No_]
																,SIH.[Bill-to Name]
																,SIH.[Prepayment Order No_]
													) UM
											LEFT JOIN	(
															SELECT	DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_] AS NO_SO
																	,MAX(SIH.[Posting Date]) AS TGL_INV
																	,SUM(GLE.[Amount]) AS AMOUNT
															FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
															LEFT JOIN	(
																			SELECT [Dimension Set ID] AS DIM_ID
																					,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																					,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																					,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																			FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																			GROUP BY [Dimension Set ID]
																		) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
															LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
															WHERE GLE.[G_L Account No_] = '400.110.03'
																  AND GLE.[Document No_] NOT LIKE 'UM%'
																  AND (GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom))
															GROUP BY DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_]
														) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
										) OUM
								WHERE OUM.AMOUNT > 0
							) ASPY
					GROUP BY ASPY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASPY.CUST_NO
							, 0 AS UPTO_PREV_MONTH
							, SUM(ASPY.AMOUNT) AS CURR_MONTH
					FROM	(
								SELECT	OUM.ITEM_CAT
										,OUM.CUST_NO
										,OUM.AMOUNT
								FROM	(
											SELECT	UM.ITEM_CAT
													, UM.CUST_NO
													, CASE WHEN ISNULL(INV.AMOUNT,0) =  0 THEN 0 ELSE
														CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN
															UM.AMOUNT 
														ELSE 
															--CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0) < ISNULL(INV.AMOUNT,0) THEN
															--	SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
															--ELSE
																ISNULL(INV.AMOUNT,0)
															--END
														END
													  END AS AMOUNT
											FROM	(
														SELECT	DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Posting Date] AS TGL_UM
																,SIH.[No_] AS NO_UM
																,SIH.[External Document No_] AS NO_PO_CUST
																,SIH.[Bill-to Customer No_] AS CUST_NO
																,SIH.[Bill-to Name] AS CUST_NAME
																,SIH.[Prepayment Order No_] AS NO_SO
																, (SUM(GLE.[Amount]) * -1) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														LEFT JOIN	(
																		SELECT CLE.[Entry No_]
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																		FROM [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE
																		LEFT JOIN [ACS].[dbo].[AUTOJAYA$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																		WHERE CLE.[Document Type] IN (2,3)
																		AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																			(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																	) CM ON CM.NO_UM = GLE.[Document No_]
														LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
															  AND GLE.[Document No_] LIKE 'UM%'
															  AND CM.NO_CM IS NULL
															  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
															  AND (SIH.[Posting Date] < @TglFrom)
															  --SINI
														GROUP BY DIMS.ITEM_CAT,
																 DIMS.BRANCHES,
																 SIH.[Posting Date]
																,SIH.[No_]
																,SIH.[External Document No_]
																,SIH.[Bill-to Customer No_]
																,SIH.[Bill-to Name]
																,SIH.[Prepayment Order No_]
													) UM
											LEFT JOIN	(
															SELECT	DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_] AS NO_SO
																	,MAX(SIH.[Posting Date]) AS TGL_INV
																	,SUM(GLE.[Amount]) AS AMOUNT
															FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
															LEFT JOIN	(
																			SELECT [Dimension Set ID] AS DIM_ID
																					,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																					,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																					,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																			FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
																			GROUP BY [Dimension Set ID]
																		) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
															LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
															WHERE GLE.[G_L Account No_] = '400.110.03'
																  AND GLE.[Document No_] NOT LIKE 'UM%'
																  AND (GLE.[Posting Date] >= @TglFrom AND GLE.[Posting Date] <= @TglUpto)
															GROUP BY DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_]
														) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
										) OUM
								WHERE OUM.AMOUNT > 0
							) ASPY
					GROUP BY ASPY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, DIMS.CUSTOMER AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AJ-ADJ$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
											,MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
									FROM [ACS].[dbo].[AJ-ADJ$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	(GLE.[G_L Account No_] BETWEEN '400.110.00'  AND '420.110.01') AND
							GLE.[G_L Account No_] <> '400.110.04' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY DIMS.CUSTOMER
					UNION ALL
					SELECT	 1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, 'SPONSORSHIP' AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AJ-ADJ$G_L Entry] GLE
					WHERE	GLE.[G_L Account No_] = '400.110.04' AND
							(('ALL') = '10' OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, SLC.CUST_NO AS CUST_NO
							, SUM(SLC.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(SLC.CURR_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	CASE WHEN GLE.[Source No_] = 'SOPE001' THEN '2. Sales INTERCOY' ELSE '1. Sales FA' END AS SALES_TITLE
										,CASE WHEN GLE.[Source No_] = 'SOPE001' THEN '(-) Sales INTERCOY' ELSE '(-) Sales FA' END AS SALES_TITLE2
										,CASE WHEN GLE.[Source No_] = 'SOPE001' THEN 'SLS-0302' ELSE 'SLS-0301' END AS SORT_SLS
										, CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										, CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										, GLE.[Source No_] AS CUST_NO
								FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND GLE.[Document No_] <> '9SIAT200197'
										AND GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <=   @TglUpto
								UNION ALL
								SELECT	'3. Others Sales Adjustment' AS SALES_TITLE
										,'(-/+) Others Management Adjustment' AS SALES_TITLE2
										,'SLS-0303' AS SORT_SLS
										, CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										, CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										, DIMS.CUSTOMER AS CUST_NO
								FROM [ACS].[dbo].[AJ-ADJ$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														, MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
												FROM [ACS].[dbo].[AJ-ADJ$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <=   @TglUpto
							) SLC
					WHERE ('ALL') = 'ALL' OR ('ALL') = '10'
					GROUP BY SLC.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, GLE.[Source No_] AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
									FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	(GLE.[G_L Account No_] BETWEEN '400.110.00'  AND '420.110.01') AND
							GLE.[G_L Account No_] <> '400.110.04' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <=  @TglUpto)
					GROUP BY GLE.[Source No_]
					UNION ALL
					SELECT	 1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, 'SPONSORSHIP' AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
					WHERE	GLE.[G_L Account No_] = '400.110.04' AND
							(('ALL') = '10' OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
					GROUP BY GLE.[Source No_]
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASCY.CUST_NO
							, SUM(ASCY.AMOUNT) * -1 AS UPTO_PREV_MONTH
							, 0 AS CURR_MONTH
					FROM (
							SELECT	OUM.ITEM_CAT
									,OUM.CUST_NO
									,OUM.AMOUNT
							FROM	(
										SELECT	UM.ITEM_CAT
												,UM.CUST_NO
												,CASE WHEN ISNULL(INV.AMOUNT,0) = 0 THEN UM.AMOUNT ELSE
													CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN 0 ELSE
													SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
												END
												END	 AS AMOUNT
										FROM	(
													SELECT	DIMS.ITEM_CAT
															,DIMS.BRANCHES
															,SIH.[Posting Date] AS TGL_UM
															,SIH.[No_] AS NO_UM
															,SIH.[External Document No_] AS NO_PO_CUST
															,SIH.[Bill-to Customer No_] AS CUST_NO
															,SIH.[Bill-to Name] AS CUST_NAME
															,SIH.[Prepayment Order No_] AS NO_SO
															, (SUM(GLE.[Amount]) * -1) AS AMOUNT
													FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
													LEFT JOIN	(												
																	SELECT [Dimension Set ID] AS DIM_ID
																			,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																			,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																			,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																	FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																	GROUP BY [Dimension Set ID]
																) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
													LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
													LEFT JOIN	(
																	SELECT CLE.[Entry No_]
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																	FROM [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE
																	LEFT JOIN [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																	WHERE CLE.[Document Type] IN (2,3)
																	AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																		(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																) CM ON CM.NO_UM = GLE.[Document No_]
													LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
													WHERE GLE.[G_L Account No_] = '400.110.03'
														  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
														  AND GLE.[Document No_] LIKE 'UM%'
														  AND (CM.NO_CM IS NULL OR (CM.NO_CM IS NOT NULL AND CMH.[Posting Date] > DATEADD(DAY,-1,@TglFrom) ))
														  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
														  AND (SIH.[Posting Date] >= @TglAwalTahun  AND SIH.[Posting Date]<= DATEADD(DAY,-1,@TglFrom))
													GROUP BY DIMS.ITEM_CAT,
															 DIMS.BRANCHES,
															 SIH.[Posting Date]
															,SIH.[No_]
															,SIH.[External Document No_]
															,SIH.[Bill-to Customer No_]
															,SIH.[Bill-to Name]
															,SIH.[Prepayment Order No_]
												) UM
										LEFT JOIN	(
														SELECT	DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_] AS NO_SO
																,MAX(SIH.[Posting Date]) AS TGL_INV
																,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT LIKE 'UM%'
															  AND GLE.[Posting Date] <=  DATEADD(DAY,-1,@TglFrom)
														GROUP BY DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_]
													) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
									) OUM
							WHERE OUM.AMOUNT > 0
						 ) ASCY
					GROUP BY ASCY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASCY.CUST_NO
							, 0 AS UPTO_PREV_MONTH
							, SUM(ASCY.AMOUNT) * -1 AS CURR_MONTH
					FROM (
							SELECT	OUM.ITEM_CAT
									,OUM.CUST_NO
									,OUM.AMOUNT
							FROM	(
										SELECT	UM.ITEM_CAT
												,UM.CUST_NO
												,CASE WHEN ISNULL(INV.AMOUNT,0) = 0 THEN UM.AMOUNT ELSE
													CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN 0 ELSE
													SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
												END
												END	 AS AMOUNT
										FROM	(
													SELECT	DIMS.ITEM_CAT
															,DIMS.BRANCHES
															,SIH.[Posting Date] AS TGL_UM
															,SIH.[No_] AS NO_UM
															,SIH.[External Document No_] AS NO_PO_CUST
															,SIH.[Bill-to Customer No_] AS CUST_NO
															,SIH.[Bill-to Name] AS CUST_NAME
															,SIH.[Prepayment Order No_] AS NO_SO
															, (SUM(GLE.[Amount]) * -1) AS AMOUNT
													FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
													LEFT JOIN	(
																	SELECT [Dimension Set ID] AS DIM_ID
																			,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																			,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																			,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																	FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																	GROUP BY [Dimension Set ID]
																) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
													LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
													LEFT JOIN	(
																	SELECT CLE.[Entry No_]
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																			, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																	FROM [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE
																	LEFT JOIN [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																	WHERE CLE.[Document Type] IN (2,3)
																	AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																		(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																) CM ON CM.NO_UM = GLE.[Document No_]
													LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
													WHERE GLE.[G_L Account No_] = '400.110.03'
														  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
														  AND GLE.[Document No_] LIKE 'UM%'
														  AND (CM.NO_CM IS NULL OR (CM.NO_CM IS NOT NULL AND CMH.[Posting Date] > @TglUpto ))
														  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
														  AND (SIH.[Posting Date] >= @TglFrom AND SIH.[Posting Date]<= @TglUpto)
													GROUP BY DIMS.ITEM_CAT,
															 DIMS.BRANCHES,
															 SIH.[Posting Date]
															,SIH.[No_]
															,SIH.[External Document No_]
															,SIH.[Bill-to Customer No_]
															,SIH.[Bill-to Name]
															,SIH.[Prepayment Order No_]
												) UM
										LEFT JOIN	(
														SELECT	DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_] AS NO_SO
																,MAX(SIH.[Posting Date]) AS TGL_INV
																,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT LIKE 'UM%'
															  AND GLE.[Posting Date] <=  @TglUpto
														GROUP BY DIMS.ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Order No_]
													) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
									) OUM
							WHERE OUM.AMOUNT > 0
						 ) ASCY
					GROUP BY ASCY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, CMLM.CUST_NO
							, 0 AS UPTO_PREV_MONTH
							, SUM(CMLM.AMOUNT) * -1 AS CURR_MONTH
					FROM	(
								SELECT	DIMS.ITEM_CAT
										,DIMS.BRANCHES
										,CMH.[Posting Date] AS TGL_CM
										,CMH.[No_] AS NO_CM
										,CMH.[External Document No_] AS NO_PO_CUST
										,CMH.[Bill-to Customer No_] AS CUST_NO
										,CMH.[Bill-to Name] AS CUST_NAME
										,CMH.[Prepayment Order No_] AS NO_SO
										, (SUM(GLE.[Amount]) * -1) AS AMOUNT
								FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
														,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
														,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
												FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								INNER JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CMH ON CMH.[No_] = GLE.[Document No_]
								LEFT JOIN	(
												SELECT CLE.[Entry No_]
														, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
														, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
												FROM [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE
												LEFT JOIN [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
												WHERE CLE.[Document Type] IN (2,3)
												AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
													(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
											) UM ON UM.NO_CM = GLE.[Document No_]
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = UM.NO_UM
								WHERE GLE.[G_L Account No_] = '400.110.03'
										AND GLE.[Document No_] NOT LIKE 'UM%'
										AND (CMH.[Posting Date] >= @TglFrom AND CMH.[Posting Date]<= @TglUpto)
										AND (SIH.[Posting Date] < @TglFrom)
								GROUP BY	DIMS.ITEM_CAT
											,DIMS.BRANCHES
											,CMH.[Posting Date]
											,CMH.[No_]
											,CMH.[External Document No_]
											,CMH.[Bill-to Customer No_]
											,CMH.[Bill-to Name]
											,CMH.[Prepayment Order No_]
							) CMLM
					GROUP BY CMLM.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASPY.CUST_NO
							, SUM(ASPY.AMOUNT) AS UPTO_PREV_MONTH
							, 0 AS CURR_MONTH
					FROM	(
								SELECT	OUM.ITEM_CAT
										,OUM.CUST_NO
										,OUM.AMOUNT
								FROM	(
											SELECT	UM.ITEM_CAT
													,UM.CUST_NO
													, CASE WHEN ISNULL(INV.AMOUNT,0) =  0 THEN 0 ELSE
														CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN
															UM.AMOUNT 
														ELSE
															--CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0) < ISNULL(INV.AMOUNT,0) THEN
															--	SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
															--ELSE
																ISNULL(INV.AMOUNT,0)
															--END
														END
													  END AS AMOUNT
											FROM	(
														SELECT	CASE WHEN SIH.[No_] = 'UMSS190005' THEN 'HW01' ELSE DIMS.ITEM_CAT END AS ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Posting Date] AS TGL_UM
																,SIH.[No_] AS NO_UM
																,SIH.[External Document No_] AS NO_PO_CUST
																,SIH.[Bill-to Customer No_] AS CUST_NO
																,SIH.[Bill-to Name] AS CUST_NAME
																,SIH.[Prepayment Order No_] AS NO_SO
																, (SUM(GLE.[Amount]) * -1) AS AMOUNT
														FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														LEFT JOIN	(
																		SELECT CLE.[Entry No_]
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																		FROM [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE
																		LEFT JOIN [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																		WHERE CLE.[Document Type] IN (2,3)
																		AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																			(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																	) CM ON CM.NO_UM = GLE.[Document No_]
														LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
															  AND GLE.[Document No_] LIKE 'UM%'
															  AND CM.NO_CM IS NULL
															  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
															  AND (SIH.[Posting Date] < @TglAwalTahun )
														GROUP BY DIMS.ITEM_CAT,
																 DIMS.BRANCHES,
																 SIH.[Posting Date]
																,SIH.[No_]
																,SIH.[External Document No_]
																,SIH.[Bill-to Customer No_]
																,SIH.[Bill-to Name]
																,SIH.[Prepayment Order No_]
													) UM
											LEFT JOIN	(
															SELECT	DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_] AS NO_SO
																	,MAX(SIH.[Posting Date]) AS TGL_INV
																	,SUM(GLE.[Amount]) AS AMOUNT
															FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
															LEFT JOIN	(
																			SELECT [Dimension Set ID] AS DIM_ID
																					,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																					,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																					,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																			FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																			GROUP BY [Dimension Set ID]
																		) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
															LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
															WHERE GLE.[G_L Account No_] = '400.110.03'
																  AND GLE.[Document No_] NOT LIKE 'UM%'
																  AND (GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom))
															GROUP BY DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_]
														) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
										) OUM
								WHERE OUM.AMOUNT > 0
							) ASPY
					GROUP BY ASPY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, ASPY.CUST_NO
							, 0 AS UPTO_PREV_MONTH
							, SUM(ASPY.AMOUNT) AS CURR_MONTH
					FROM	(
								SELECT	OUM.ITEM_CAT
										,OUM.CUST_NO
										,OUM.AMOUNT
								FROM	(
											SELECT	UM.ITEM_CAT
													, UM.CUST_NO
													, CASE WHEN ISNULL(INV.AMOUNT,0) =  0 THEN 0 ELSE
														CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) <= ISNULL(INV.AMOUNT,0) THEN
															UM.AMOUNT 
														ELSE
															--CASE WHEN SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0) < ISNULL(INV.AMOUNT,0) THEN
															--	SUM(UM.AMOUNT)OVER(PARTITION BY UM.NO_SO, UM.BRANCHES, UM.ITEM_CAT  ORDER BY UM.TGL_UM) - ISNULL(INV.AMOUNT,0)
															--ELSE
																ISNULL(INV.AMOUNT,0)
															--END
														END
													  END AS AMOUNT
											FROM	(
														SELECT	CASE WHEN SIH.[No_] = 'UMSS190005' THEN 'HW01' ELSE DIMS.ITEM_CAT END AS ITEM_CAT
																,DIMS.BRANCHES
																,SIH.[Posting Date] AS TGL_UM
																,SIH.[No_] AS NO_UM
																,SIH.[External Document No_] AS NO_PO_CUST
																,SIH.[Bill-to Customer No_] AS CUST_NO
																,SIH.[Bill-to Name] AS CUST_NAME
																,SIH.[Prepayment Order No_] AS NO_SO
																, (SUM(GLE.[Amount]) * -1) AS AMOUNT
														FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
														LEFT JOIN	(
																		SELECT [Dimension Set ID] AS DIM_ID
																				,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																				,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																				,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																		FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																		GROUP BY [Dimension Set ID]
																	) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
														LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
														LEFT JOIN	(
																		SELECT CLE.[Entry No_]
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE.[Document No_] ELSE CLE2.[Document No_] END AS NO_UM
																				, CASE WHEN CLE.[Document No_] LIKE 'UM%' THEN CLE2.[Document No_] ELSE CLE.[Document No_] END AS NO_CM
																		FROM [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE
																		LEFT JOIN [ACS].[dbo].[SOLUSI$Cust_ Ledger Entry] CLE2 ON CLE2.[Entry No_] = CLE.[Closed by Entry No_]
																		WHERE CLE.[Document Type] IN (2,3)
																		AND ((CLE.[Document No_]  LIKE 'UM%' AND CLE2.[Document Type] = 3) OR
																			(CLE2.[Document No_]  LIKE 'UM%' AND CLE.[Document Type] = 3) )
																	) CM ON CM.NO_UM = GLE.[Document No_]
														LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CMH ON CMH.[No_] = CM.NO_CM
														WHERE GLE.[G_L Account No_] = '400.110.03'
															  AND GLE.[Document No_] NOT IN ('UMST210032', 'UMST210034')
															  AND GLE.[Document No_] LIKE 'UM%'
															  AND CM.NO_CM IS NULL
															  AND (DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL')
															  AND (SIH.[Posting Date] < @TglFrom)
														-- SINI
														GROUP BY DIMS.ITEM_CAT,
																 DIMS.BRANCHES,
																 SIH.[Posting Date]
																,SIH.[No_]
																,SIH.[External Document No_]
																,SIH.[Bill-to Customer No_]
																,SIH.[Bill-to Name]
																,SIH.[Prepayment Order No_]
													) UM
											LEFT JOIN	(
															SELECT	DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_] AS NO_SO
																	,MAX(SIH.[Posting Date]) AS TGL_INV
																	,SUM(GLE.[Amount]) AS AMOUNT
															FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
															LEFT JOIN	(
																			SELECT [Dimension Set ID] AS DIM_ID
																					,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
																					,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
																					,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
																			FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
																			GROUP BY [Dimension Set ID]
																		) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
															LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH ON SIH.[No_] = GLE.[Document No_]
															WHERE GLE.[G_L Account No_] = '400.110.03'
																  AND GLE.[Document No_] NOT LIKE 'UM%'
																  AND (GLE.[Posting Date] >= @TglFrom AND GLE.[Posting Date] <= @TglUpto)
															GROUP BY DIMS.ITEM_CAT
																	,DIMS.BRANCHES
																	,SIH.[Order No_]
														) INV ON INV.NO_SO = UM.NO_SO AND INV.BRANCHES = UM.BRANCHES AND INV.ITEM_CAT = UM.ITEM_CAT
										) OUM
								WHERE OUM.AMOUNT > 0
							) ASPY
					GROUP BY ASPY.CUST_NO
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, DIMS.CUSTOMER AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SP-ADJ$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
											,MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
									FROM [ACS].[dbo].[SP-ADJ$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	(GLE.[G_L Account No_] BETWEEN '400.110.00'  AND '420.110.01') AND
							GLE.[G_L Account No_] <> '400.110.04' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY DIMS.CUSTOMER
					UNION ALL
					SELECT	 1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, 'SPONSORSHIP' AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SP-ADJ$G_L Entry] GLE
					WHERE	GLE.[G_L Account No_] = '400.110.04' AND
							(('ALL') = '10' OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					UNION ALL
					SELECT	1 AS GROUP_NO
							, 'SALES' AS GROUP_DESC
							, SLC.CUST_NO AS CUST_NO
							, SUM(SLC.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(SLC.CURR_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	CASE WHEN GLE.[Source No_] <> 'SOPE001' THEN '2. Sales INTERCOY' ELSE '1. Sales FA' END AS SALES_TITLE
										,CASE WHEN GLE.[Source No_] <> 'SOPE001' THEN '(-) Sales INTERCOY' ELSE '(-) Sales FA' END AS SALES_TITLE2
										,CASE WHEN GLE.[Source No_] <> 'SOPE001' THEN 'SLS-0302' ELSE 'SLS-0301' END AS SORT_SLS
										, CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										, CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										, GLE.[Source No_] AS CUST_NO
								FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND (GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <= @TglUpto)
								UNION ALL
								SELECT	'3. Others Sales Adjustment' AS SALES_TITLE
										,'(-/+) Others Management Adjustment' AS SALES_TITLE2
										,'SLS-0303' AS SORT_SLS
										, CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										, CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										, DIMS.CUSTOMER AS CUST_NO
								FROM [ACS].[dbo].[SP-ADJ$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														,MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
												FROM [ACS].[dbo].[SP-ADJ$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND GLE.[Posting Date] >= @TglAwalTahun  AND GLE.[Posting Date] <= @TglUpto
							) SLC
					WHERE ('ALL') = 'ALL' OR ('ALL') = '10'
					GROUP BY SLC.CUST_NO
					UNION ALL
					SELECT	CX.GROUP_NO
							,CX.GROUP_DESC
							, CASE WHEN DC.CUST_NO IS NULL THEN 'ADJUSTMENT-COGS' ELSE DC.CUST_NO END AS CUST_NO
							, SUM(CX.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(CX.CURR_MONTH) AS CURR_MONTH
					FROM	(
					SELECT	 2 AS GROUP_NO
							, GLE.[Document No_] AS CUST_NO
							, 'COGS' AS GROUP_DESC
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
									FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	GLE.[G_L Account No_] BETWEEN '500.110.00'  AND '500.111.00' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY [Document No_]
					UNION ALL
					SELECT	 2 AS GROUP_NO
							, GLE.[Document No_] AS CUST_NO
							, 'COGS' AS GROUP_DESC
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
									FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	GLE.[G_L Account No_] BETWEEN '500.110.00'  AND '500.111.00' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY [Document No_]
							) CX
					LEFT JOIN	(
									SELECT [No_] AS DOC_NO, [Bill-to Customer No_] AS CUST_NO FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header]
									UNION ALL
									SELECT [No_] AS DOC_NO, [Bill-to Customer No_] AS CUST_NO FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header]
									UNION ALL
									SELECT [No_] AS DOC_NO, [Bill-to Customer No_] AS CUST_NO FROM [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header]
									UNION ALL
									SELECT [No_] AS DOC_NO, [Bill-to Customer No_] AS CUST_NO FROM [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header]
									UNION ALL
									SELECT [No_] AS DOC_NO, [Bill-to Customer No_] AS CUST_NO FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Header]
									UNION ALL
									SELECT [No_] AS DOC_NO, [Bill-to Customer No_] AS CUST_NO FROM [ACS].[dbo].[SOLUSI$Sales Shipment Header]
								) DC ON DC.DOC_NO = CX.CUST_NO
					GROUP BY CX.GROUP_NO, CX.GROUP_DESC, DC.CUST_NO
					UNION ALL
					SELECT	2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, DOC.CUST_NO
							, SUM(DOC.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(DOC.UPTO_CURR_MONTH) - SUM(DOC.UPTO_PREV_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	DII.CUST_NO
										, SUM(DII.AMOUNT) * -1 AS UPTO_PREV_MONTH
										, 0 AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM	(
														SELECT GLE.[Posting Date] AS TGL_SJ
															  ,GLE.[Document No_] AS NO_SJ
															  ,DOA.[Bill-to Customer No_] AS CUST_NO
															  ,GLE.[Global Dimension 1 Code] AS CABANG
															  ,GLE.[Global Dimension 2 Code] AS CATEGORY
															  ,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_]= '500.110.00'
																AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
														GROUP BY GLE.[Posting Date], GLE.[Document No_]
																,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
																,DOA.[Bill-to Customer No_]
													) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
											)
										)
										AND (	DII.NO_INVOICE IS NULL
												OR
												SIH3.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
											)
										AND (DII.TGL_SJ >= @TglAwalTahun   AND DII.TGL_SJ <= DATEADD(DAY,-1,@TglFrom))
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
								UNION ALL
								SELECT	DII.CUST_NO
										, 0 AS UPTO_PREV_MONTH
										, SUM(DII.AMOUNT) * -1 AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM	(
														SELECT GLE.[Posting Date] AS TGL_SJ
															  ,GLE.[Document No_] AS NO_SJ
															  ,DOA.[Bill-to Customer No_] AS CUST_NO
															  ,GLE.[Global Dimension 1 Code] AS CABANG
															  ,GLE.[Global Dimension 2 Code] AS CATEGORY
															  ,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_]= '500.110.00'
																AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
														GROUP BY GLE.[Posting Date], GLE.[Document No_]
																,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
																,DOA.[Bill-to Customer No_]
													) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > @TglUpto
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > @TglUpto
											)
										)
										AND (	DII.NO_INVOICE IS NULL
												OR
												SIH3.[Posting Date] > @TglUpto
											)
										AND (DII.TGL_SJ >= @TglAwalTahun  AND DII.TGL_SJ <= @TglUpto)
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
							) DOC
					GROUP BY DOC.CUST_NO
					UNION ALL
					SELECT	2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, DOP.CUST_NO
							, SUM(DOP.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(DOP.UPTO_CURR_MONTH) - SUM(DOP.UPTO_PREV_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	DII.CUST_NO
										, SUM(DII.AMOUNT) AS UPTO_PREV_MONTH
										, 0 AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM	(
														SELECT GLE.[Posting Date] AS TGL_SJ
															  ,GLE.[Document No_] AS NO_SJ
															  ,DOA.[Bill-to Customer No_] AS CUST_NO
															  ,GLE.[Global Dimension 1 Code] AS CABANG
															  ,GLE.[Global Dimension 2 Code] AS CATEGORY
															  ,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_]= '500.110.00'
																AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
														GROUP BY GLE.[Posting Date], GLE.[Document No_]
																,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
																,DOA.[Bill-to Customer No_]
													) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
											)
										)
										AND (SIH3.[Posting Date] >= @TglAwalTahun   AND SIH3.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) )
										AND (DII.TGL_SJ < @TglAwalTahun )
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
								UNION ALL
								SELECT	DII.CUST_NO
										, 0 AS UPTO_PREV_MONTH
										, SUM(DII.AMOUNT) AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM	(
														SELECT GLE.[Posting Date] AS TGL_SJ
															  ,GLE.[Document No_] AS NO_SJ
															  ,DOA.[Bill-to Customer No_] AS CUST_NO
															  ,GLE.[Global Dimension 1 Code] AS CABANG
															  ,GLE.[Global Dimension 2 Code] AS CATEGORY
															  ,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
														INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_]= '500.110.00'
																AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
														GROUP BY GLE.[Posting Date], GLE.[Document No_]
																,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
																,DOA.[Bill-to Customer No_]
													) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > @TglUpto
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[AUTOJAYA$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > @TglUpto
											)
										)
										AND (SIH3.[Posting Date] >= @TglAwalTahun  AND SIH3.[Posting Date] <= @TglUpto )
										AND (DII.TGL_SJ < @TglAwalTahun)
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
							) DOP
					GROUP BY DOP.CUST_NO
					UNION ALL
					SELECT	 2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, CASE WHEN DIMS.CUSTOMER IS NULL THEN 'MANAGEMENT-ADJUSTMENT-COGS' ELSE DIMS.CUSTOMER END AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AJ-ADJ$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
											,MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
									FROM [ACS].[dbo].[AJ-ADJ$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	GLE.[G_L Account No_] BETWEEN '500.110.00'  AND '500.111.00' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY DIMS.CUSTOMER
					UNION ALL
					SELECT	2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, SLC.CUST_NO
							, SUM(SLC.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(SLC.CURR_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	CASE	WHEN DIMS.ITEM_CAT = 'HW01' THEN '1. HARDWARE'
												WHEN DIMS.ITEM_CAT = 'PS01' THEN '2. 3rd PARTY SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS02' THEN '3. OWN SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS03' THEN '4. TECHNOLOGY SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS04' THEN '5. HARDWARE SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS05' THEN '6. MANAGE SERVICE'
										END AS GRUP_TITLE
										,CASE WHEN GLE.[Source No_] = 'SOPE001' THEN '2. COGS INTERCOY' ELSE '1. COGS FA' END AS SALES_TITLE
										,CASE WHEN GLE.[Source No_] = 'SOPE001' THEN '(-) COGS INTERCOY' ELSE '(-) COGS FA' END AS SALES_TITLE2
										,CASE WHEN GLE.[Source No_] = 'SOPE001' THEN 'SLS-0402' ELSE 'SLS-0401' END AS SORT_SLS
										,CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										,CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										,GLE.[Source No_] AS CUST_NO
								FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
														,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
														,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
												FROM [ACS].[dbo].[AUTOJAYA$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND GLE.[Document No_] <> '9SIAT200197'
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
								UNION ALL
								SELECT	CASE	WHEN DIMS.ITEM_CAT = 'HW01' THEN '1. HARDWARE'
												WHEN DIMS.ITEM_CAT = 'PS01' THEN '2. 3rd PARTY SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS02' THEN '3. OWN SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS03' THEN '4. TECHNOLOGY SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS04' THEN '5. HARDWARE SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS05' THEN '6. MANAGE SERVICE'
										END AS GRUP_TITLE
										,CASE WHEN GLE.[Description] LIKE 'FA%' THEN '1. COGS FA' ELSE '2. COGS INTERCOY' END AS SALES_TITLE
										,'(-/+) Others Management Adjustment' AS SALES_TITLE2
										,'SLS-0403' AS SORT_SLS
										, CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										, CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										, CASE WHEN DIMS.CUSTOMER IS NULL THEN 'MANAGEMENT-ADJUSTMENT-COGS' ELSE DIMS.CUSTOMER END AS CUST_NO
								FROM [ACS].[dbo].[AJ-ADJ$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
														,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
														,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
														,MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
												FROM [ACS].[dbo].[AJ-ADJ$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
							) SLC
					WHERE ('ALL') = 'ALL' OR ('ALL') = '10'
					GROUP BY SLC.CUST_NO
					UNION ALL
					SELECT	2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, DOC.CUST_NO
							, SUM(DOC.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(DOC.UPTO_CURR_MONTH) - SUM(DOC.UPTO_PREV_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	DII.CUST_NO
										, SUM(DII.AMOUNT) * -1 AS UPTO_PREV_MONTH
										, 0 AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[SOLUSI$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM	(
														SELECT GLE.[Posting Date] AS TGL_SJ
															  ,GLE.[Document No_] AS NO_SJ
															  ,DOA.[Bill-to Customer No_] AS CUST_NO
															  ,GLE.[Global Dimension 1 Code] AS CABANG
															  ,GLE.[Global Dimension 2 Code] AS CATEGORY
															  ,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
														INNER JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_]= '500.110.00'
																AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
														GROUP BY GLE.[Posting Date], GLE.[Document No_]
																,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
																,DOA.[Bill-to Customer No_]
													) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[SOLUSI$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
											)
										)
										AND (	DII.NO_INVOICE IS NULL
												OR
												SIH3.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
											)
										AND (DII.TGL_SJ >= @TglAwalTahun   AND DII.TGL_SJ <= DATEADD(DAY,-1,@TglFrom))
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
								UNION ALL
								SELECT	DII.CUST_NO
										, 0 AS UPTO_PREV_MONTH
										, SUM(DII.AMOUNT) * -1 AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[SOLUSI$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM	(
														SELECT GLE.[Posting Date] AS TGL_SJ
															  ,GLE.[Document No_] AS NO_SJ
															  ,DOA.[Bill-to Customer No_] AS CUST_NO
															  ,GLE.[Global Dimension 1 Code] AS CABANG
															  ,GLE.[Global Dimension 2 Code] AS CATEGORY
															  ,SUM(GLE.[Amount]) AS AMOUNT
														FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
														INNER JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
														WHERE GLE.[G_L Account No_]= '500.110.00'
																AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
														GROUP BY GLE.[Posting Date], GLE.[Document No_]
																,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
																,DOA.[Bill-to Customer No_]
													) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[SOLUSI$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > @TglUpto
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > @TglUpto
											)
										)
										AND (	DII.NO_INVOICE IS NULL
												OR
												SIH3.[Posting Date] > @TglUpto
											)
										AND (DII.TGL_SJ >= @TglAwalTahun  AND DII.TGL_SJ <= @TglUpto)
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
							) DOC
					GROUP BY DOC.CUST_NO
					UNION ALL
					SELECT	2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, DOP.CUST_NO
							, SUM(DOP.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(DOP.UPTO_CURR_MONTH) - SUM(DOP.UPTO_PREV_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	DII.CUST_NO
										, SUM(DII.AMOUNT) AS UPTO_PREV_MONTH
										, 0 AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[SOLUSI$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM
											(
												SELECT GLE.[Posting Date] AS TGL_SJ
													  ,GLE.[Document No_] AS NO_SJ
													  ,DOA.[Bill-to Customer No_] AS CUST_NO
													  ,GLE.[Global Dimension 1 Code] AS CABANG
													  ,GLE.[Global Dimension 2 Code] AS CATEGORY
													  ,SUM(GLE.[Amount]) AS AMOUNT
												FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
												INNER JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
												WHERE GLE.[G_L Account No_]= '500.110.00'
														AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
												GROUP BY GLE.[Posting Date], GLE.[Document No_]
														,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
														,DOA.[Bill-to Customer No_] 
											) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[SOLUSI$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > DATEADD(DAY,-1,@TglFrom)
											)
										)
										AND (SIH3.[Posting Date] >= @TglAwalTahun   AND SIH3.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) )
										AND (DII.TGL_SJ < @TglAwalTahun )
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
								UNION ALL
								SELECT	DII.CUST_NO
										, 0 AS UPTO_PREV_MONTH
										, SUM(DII.AMOUNT) AS UPTO_CURR_MONTH
								FROM	(
											SELECT	DOO.TGL_SJ
													,DOO.NO_SJ
													,DOO.CUST_NO
													,DOO.CABANG
													,DOO.CATEGORY
													,DOO.AMOUNT
													,CASE WHEN DOI.NO_INVOICE IS NULL AND
														(
															SELECT CASE WHEN SUM(SHL.[Quantity]) = SUM(SHL.[Quantity Invoiced]) THEN 'Y' ELSE 'N' END AS INV
															FROM [ACS].[dbo].[SOLUSI$Sales Shipment Line] SHL
															WHERE SHL.[Document No_] = DOO.NO_SJ
															GROUP BY SHL.[Document No_]
														) = 'Y' THEN
														(
															SELECT MAX(IOO.NO_INV)
															FROM	(
																		SELECT
																				DISTINCT SIH.[No_] AS NO_INV,
																				SIH.[Posting Date] AS TGL_INV,
																				CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																		FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																		INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																		LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																		WHERE SIL.[Type] = 2
																	)IOO
															WHERE IOO.NO_DO  = DOO.NO_SJ AND
																  IOO.TGL_INV < DOO.TGL_SJ
														) ELSE DOI.NO_INVOICE END AS NO_INVOICE
													,DOI.TGL_INV
											FROM
											(
												SELECT GLE.[Posting Date] AS TGL_SJ
													  ,GLE.[Document No_] AS NO_SJ
													  ,DOA.[Bill-to Customer No_] AS CUST_NO
													  ,GLE.[Global Dimension 1 Code] AS CABANG
													  ,GLE.[Global Dimension 2 Code] AS CATEGORY
													  ,SUM(GLE.[Amount]) AS AMOUNT
												FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
												INNER JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[No_] = GLE.[Document No_]
												WHERE GLE.[G_L Account No_]= '500.110.00'
														AND DOA.[Bill-to Customer No_] NOT IN ('SOPE001', 'AUJA001', 'AUJA002')
												GROUP BY GLE.[Posting Date], GLE.[Document No_]
														,GLE.[Global Dimension 1 Code] ,GLE.[Global Dimension 2 Code]
														,DOA.[Bill-to Customer No_]
											) DOO
											LEFT JOIN	(
															SELECT	XXX.NO_SJ
																	,XXX.TGL_INV
																	,MAX(ISJ.[No_]) AS NO_INVOICE
															FROM
																	(
																		SELECT DO.[No_] AS NO_SJ
																				, MIN(ISJ2.TGL_INV) AS TGL_INV
																		FROM [ACS].[dbo].[SOLUSI$Sales Shipment Header] DO
																		LEFT JOIN (
																					SELECT	SIH2.[Posting Date] AS TGL_INV
																							,CONVERT(VARCHAR(6), SIH2.[Posting Date], 112) AS PERIODE_INV
																							,CASE WHEN SIL2.[Shipment No_] <> '' THEN SIL2.[Shipment No_] ELSE DOA2.[No_] END AS NO_DO
																					FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH2
																					INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL2 ON SIL2.[Document No_] = SIH2.[No_]
																					LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA2 ON DOA2.[Order No_] = SIH2.[Order No_]
																					WHERE SIL2.[Type] = 2
																				  ) ISJ2 ON ISJ2.NO_DO  = DO.[No_] AND ISJ2.PERIODE_INV >= CONVERT(VARCHAR(6), DO.[Posting Date], 112)
																		GROUP BY DO.[No_]
																	) XXX
															LEFT JOIN	(
																			SELECT
																					SIH.[No_],
																					SIH.[Posting Date],
																					CASE WHEN SIL.[Shipment No_] <> '' THEN SIL.[Shipment No_] ELSE DOA.[No_] END AS NO_DO
																			FROM [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH
																			INNER JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Line] SIL ON SIL.[Document No_] = SIH.[No_]
																			LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Shipment Header] DOA ON DOA.[Order No_] = SIH.[Order No_]
																			WHERE SIL.[Type] = 2
																		) ISJ ON ISJ.NO_DO = XXX.NO_SJ AND ISJ.[Posting Date] = XXX.TGL_INV
															GROUP BY  XXX.NO_SJ, XXX.TGL_INV
														) DOI ON DOI.NO_SJ = DOO.NO_SJ
											LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM ON CRM.[Applies-to Doc_ No_] = DOI.NO_INVOICE
											WHERE	DOO.AMOUNT <> 0 AND
													(
														CRM.[No_] IS NULL OR
														(	CRM.[No_] IS NOT NULL AND
															CRM.[Posting Date] > @TglUpto
														)
													)
										) DII
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Invoice Header] SIH3 ON SIH3.[No_] = DII.NO_INVOICE
								LEFT JOIN [ACS].[dbo].[SOLUSI$Sales Cr_Memo Header] CRM2 ON CRM2.[Applies-to Doc_ No_] = DII.NO_INVOICE
								WHERE	(
											CRM2.[No_] IS NULL OR
											(	CRM2.[No_] IS NOT NULL AND
												CRM2.[Posting Date] > @TglUpto
											)
										)
										AND (SIH3.[Posting Date] >= @TglAwalTahun  AND SIH3.[Posting Date] <= @TglUpto )
										AND (DII.TGL_SJ < @TglAwalTahun)
										AND (DII.CABANG = ('ALL') OR ('ALL') = 'ALL')
								GROUP BY DII.CUST_NO
							) DOP
					GROUP BY DOP.CUST_NO
					UNION ALL
					SELECT	2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, CASE WHEN DIMS.CUSTOMER IS NULL THEN 'MANAGEMENT-ADJUSTMENT-COGS' ELSE DIMS.CUSTOMER END AS CUST_NO
							, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SP-ADJ$G_L Entry] GLE
					LEFT JOIN	(
									SELECT [Dimension Set ID] AS DIM_ID
											,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
											,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
											,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
											,MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
									FROM [ACS].[dbo].[SP-ADJ$Dimension Set Entry]
									GROUP BY [Dimension Set ID]
								) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
					WHERE	GLE.[G_L Account No_] BETWEEN '500.110.00'  AND '500.111.00' AND
							DIMS.ITEM_CAT <> '' AND
							(DIMS.BRANCHES = ('ALL') OR ('ALL') = 'ALL') AND
							(GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY DIMS.CUSTOMER
					UNION ALL
					SELECT	2 AS GROUP_NO
							, 'COGS' AS GROUP_DESC
							, SLC.CUST_NO
							, SUM(SLC.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
							, SUM(SLC.CURR_MONTH) AS CURR_MONTH
					FROM	(
								SELECT	CASE	WHEN DIMS.ITEM_CAT = 'HW01' THEN '1. HARDWARE'
												WHEN DIMS.ITEM_CAT = 'PS01' THEN '2. 3rd PARTY SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS02' THEN '3. OWN SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS03' THEN '4. TECHNOLOGY SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS04' THEN '5. HARDWARE SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS05' THEN '6. MANAGE SERVICE'
										END AS GRUP_TITLE
										,CASE WHEN GLE.[Source No_] <> 'SOPE001' THEN '2. COGS INTERCOY' ELSE '1. COGS FA' END AS SALES_TITLE
										,CASE WHEN GLE.[Source No_] <> 'SOPE001' THEN '(-) COGS INTERCOY' ELSE '(-) COGS FA' END AS SALES_TITLE2
										,CASE WHEN GLE.[Source No_] <> 'SOPE001' THEN 'SLS-0402' ELSE 'SLS-0401' END AS SORT_SLS
										,CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										,CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										,GLE.[Source No_] AS CUST_NO
								FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
														,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
														,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
												FROM [ACS].[dbo].[SOLUSI$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
								UNION ALL
								SELECT	CASE	WHEN DIMS.ITEM_CAT = 'HW01' THEN '1. HARDWARE'
												WHEN DIMS.ITEM_CAT = 'PS01' THEN '2. 3rd PARTY SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS02' THEN '3. OWN SOFTWARE'
												WHEN DIMS.ITEM_CAT = 'PS03' THEN '4. TECHNOLOGY SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS04' THEN '5. HARDWARE SERVICE'
												WHEN DIMS.ITEM_CAT = 'PS05' THEN '6. MANAGE SERVICE'
										END AS GRUP_TITLE
										,CASE WHEN GLE.[Description] LIKE 'FA%' THEN '1. COGS FA' ELSE '2. COGS INTERCOY' END AS SALES_TITLE
										,'(-/+) Others Management Adjustment' AS SALES_TITLE2
										,'SLS-0403' AS SORT_SLS
										, CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS UPTO_PREV_MONTH
										, CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] ELSE 0 END AS CURR_MONTH
										, CASE WHEN DIMS.CUSTOMER IS NULL THEN 'MANAGEMENT-ADJUSTMENT-COGS' ELSE DIMS.CUSTOMER END AS CUST_NO
								FROM [ACS].[dbo].[SP-ADJ$G_L Entry] GLE
								LEFT JOIN	(
												SELECT [Dimension Set ID] AS DIM_ID
														,MAX(CASE WHEN [Dimension Code] = 'BRANCHES' THEN [Dimension Value Code] ELSE NULL END) AS BRANCHES
														,MAX(CASE WHEN [Dimension Code] = 'ITEM CATEGORY' THEN [Dimension Value Code] ELSE NULL END) AS ITEM_CAT
														,MAX(CASE WHEN [Dimension Code] = 'SALESMAN' THEN [Dimension Value Code] ELSE NULL END) AS SALESMAN
														,MAX(CASE WHEN [Dimension Code] = 'CUSTOMER' THEN [Dimension Value Code] ELSE NULL END) AS CUSTOMER
												FROM [ACS].[dbo].[SP-ADJ$Dimension Set Entry]
												GROUP BY [Dimension Set ID]
											) DIMS ON DIMS.DIM_ID = GLE.[Dimension Set ID]
								WHERE GLE.[G_L Account No_] IN ('400.110.01', '410.110.01', '420.110.01')
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <=  @TglUpto)
							) SLC
					WHERE ('ALL') = 'ALL' OR ('ALL') = '10'
					GROUP BY SLC.CUST_NO
					UNION ALL
					SELECT	RBT.GROUP_NO
							, RBT.GROUP_DESC
							, 'N/A' AS CUST_NO
							, SUM(ISNULL(RBT.UPTO_PREV_MONTH,0)) AS UPTO_PREV_MONTH
							, SUM(ISNULL(RBT.CURR_MONTH,0)) AS CURR_MONTH 
					FROM	(
								SELECT	3 AS GROUP_NO
										, 'REBATE' AS GROUP_DESC
										, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS UPTO_PREV_MONTH
										, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS CURR_MONTH
								FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
								WHERE	GLE.[G_L Account No_] = '600.110.00'
										AND (GLE.[Global Dimension 1 Code] = ('ALL') OR ('ALL') = 'ALL')
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
								UNION ALL
								SELECT	3 AS GROUP_NO
										, 'REBATE' AS GROUP_DESC
										, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS UPTO_PREV_MONTH
										, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS CURR_MONTH
								FROM [ACS].[dbo].[AJ-ADJ$G_L Entry] GLE
								WHERE	GLE.[G_L Account No_] = '600.110.00'
										AND (GLE.[Global Dimension 1 Code] = ('ALL') OR ('ALL') = 'ALL')
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
								UNION ALL
								SELECT	3 AS GROUP_NO
										, 'REBATE' AS GROUP_DESC
										, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS UPTO_PREV_MONTH
										, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS CURR_MONTH
								FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
								WHERE	GLE.[G_L Account No_] IN ( '600.110.00', '600.120.00')
										AND (GLE.[Global Dimension 1 Code] = ('ALL') OR ('ALL') = 'ALL')
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
								UNION ALL
								SELECT	3 AS GROUP_NO
										, 'REBATE' AS GROUP_DESC
										, SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS UPTO_PREV_MONTH
										, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN ISNULL(GLE.[Amount],0) ELSE 0 END) * -1 AS CURR_MONTH
								FROM [ACS].[dbo].[SP-ADJ$G_L Entry] GLE
								WHERE	GLE.[G_L Account No_] IN ( '600.110.00', '600.120.00')
										AND (GLE.[Global Dimension 1 Code] = ('ALL') OR ('ALL') = 'ALL')
										AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
							) RBT
					GROUP BY RBT.GROUP_NO, RBT.GROUP_DESC
				) X
		GROUP BY X.GROUP_NO, X.GROUP_DESC, X.CUST_NO
		UNION ALL
		SELECT	'B' AS MAIN_GRP
				, 1 AS GROUP_NO
				, 'EXCHANGE GAIN/(LOSS)' AS GROUP_DESC
				, 'N/A' AS CUST_NO
				, SUM(X.UPTO_PREV_MONTH) AS UPTO_PREV_MONTH
				, SUM(X.CURR_MONTH) AS CURR_MONTH		
		FROM	(
					SELECT
							SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1 ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AUTOJAYA$G_L Entry] GLE
					LEFT JOIN  [ACS].[dbo].[AUTOJAYA$G_L Account] GLA ON GLA.[No_] = GLE.[G_L Account No_]
					WHERE GLE.[G_L Account No_] IN ('990.220.90','990.225.90')
							AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY [G_L Account No_],GLA.[Name]
					UNION ALL
					SELECT
							SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1 ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1 ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SOLUSI$G_L Entry] GLE
					LEFT JOIN  [ACS].[dbo].[SOLUSI$G_L Account] GLA ON GLA.[No_] = GLE.[G_L Account No_]
					WHERE GLE.[G_L Account No_] IN ('990.220.90','990.225.90')
							AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY [G_L Account No_],GLA.[Name]
					UNION ALL
					SELECT
							SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1  ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1 ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[AJ-ADJ$G_L Entry] GLE
					LEFT JOIN  [ACS].[dbo].[AJ-ADJ$G_L Account] GLA ON GLA.[No_] = GLE.[G_L Account No_]
					WHERE GLE.[G_L Account No_] IN ('990.220.90','990.225.90')
							AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY [G_L Account No_],GLA.[Name]
					UNION ALL
					SELECT
							SUM(CASE WHEN GLE.[Posting Date] <= DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1 ELSE 0 END) AS UPTO_PREV_MONTH
							, SUM(CASE WHEN GLE.[Posting Date] >  DATEADD(DAY,-1,@TglFrom) THEN GLE.[Amount] * -1 ELSE 0 END) AS CURR_MONTH
					FROM [ACS].[dbo].[SP-ADJ$G_L Entry] GLE
					LEFT JOIN  [ACS].[dbo].[SP-ADJ$G_L Account] GLA ON GLA.[No_] = GLE.[G_L Account No_]
					WHERE GLE.[G_L Account No_] IN ('990.220.90','990.225.90')
							AND (GLE.[Posting Date] >= @TglAwalTahun AND GLE.[Posting Date] <= @TglUpto)
					GROUP BY [G_L Account No_],GLA.[Name]
				) X
				) XX;
		--
		RETURN  ;
	END;
	--
	IF @Action = 'DELETE' 
	BEGIN
		DELETE FROM [dbo].[TEMP11_GROSS_SALES_MARGIN]
		WHERE [PROSES_ID] = @ProsesId;
		--
		RETURN  ;
	END;
END;
